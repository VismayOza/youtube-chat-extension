<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YouTube Live Chat Fetcher</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .profile-img {
        margin-left: 1rem; /* Adjust as needed for ms-3 */
        margin-right: 1rem; /* Adjust as needed for me-3 */
        height: 60px;
        width: auto;
        object-fit: cover;
        border-radius: 50%;
      }

      .chat-messages {
        max-height: 600px; /* Adjust height as needed */
        overflow-y: auto; /* Enable vertical scrolling */
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        background-color: #f9f9f9;
      }

      .chat-message {
        background-color: #0c0c0c33;
        position: relative;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        overflow: hidden;
        border-radius: 5px;
      }

      .chat-checkbox {
        margin-right: 10px;
      }
      .line-through-overlay {
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        height: 2px;
        background-color: gray;
        transform: translateY(-50%);
        display: none;
      }
      .message-container {
        display: flex;
        align-items: center;
      }
      .message-text {
        flex: 1;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>YouTube Live Chat Fetcher</h1>
      <div class="mb-3">
        <label for="channelName" class="form-label">Channel Name</label>
        <input
          type="text"
          class="form-control"
          id="channelName"
          placeholder="Enter YouTube Channel Name"
          value="chindymaireza8520"
        />
        <button id="fetchChat" class="btn btn-primary mt-3">
          Fetch Live Chat
        </button>
        <button id="uncheck-all-button" class="btn btn-primary mt-3">
          Uncheck All
        </button>
      </div>
      <div id="chatMessages" class="chat-messages"></div>
    </div>

    <script>
      const API_KEY = "AIzaSyDdKP2lGmu8sLnEBrCkiIWvQz3zWpr6tbI";

      // Function to get channel ID by channel name
      async function getChannelId(channelName) {
        try {
          const response = await fetch(
            `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${channelName}&type=channel&key=${API_KEY}`
          );
          const data = await response.json();
          if (data.items && data.items.length > 0) {
            return data.items[0].id.channelId;
          }
        } catch (error) {
          console.error("Error fetching channel ID:", error);
        }
        return null;
      }

      // Function to get the latest live video by channel ID
      async function getLatestLiveVideoId(channelId) {
        try {
          const response = await fetch(
            `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${channelId}&type=video&eventType=live&key=${API_KEY}`
          );
          const data = await response.json();
          if (data.items && data.items.length > 0) {
            return data.items[0].id.videoId;
          }
        } catch (error) {
          console.error("Error fetching live video ID:", error);
        }
        return null;
      }

      // Function to get the active live chat ID by video ID
      async function getActiveLiveChatId(videoId) {
        try {
          const response = await fetch(
            `https://www.googleapis.com/youtube/v3/videos?part=liveStreamingDetails&id=${videoId}&key=${API_KEY}`
          );
          const data = await response.json();
          if (
            data.items &&
            data.items.length > 0 &&
            data.items[0].liveStreamingDetails &&
            data.items[0].liveStreamingDetails.activeLiveChatId
          ) {
            return data.items[0].liveStreamingDetails.activeLiveChatId;
          }
        } catch (error) {
          console.error("Error fetching live chat ID:", error);
        }
        return null;
      }

      // Function to fetch and display live chat messages by live chat ID
      async function fetchLiveChatMessages(liveChatId) {
        try {
          const response = await fetch(
            `https://www.googleapis.com/youtube/v3/liveChat/messages?liveChatId=${liveChatId}&part=snippet,authorDetails&key=${API_KEY}`
          );
          const data = await response.json();
          if (data.items) {
            displayChatMessages(data.items);
          }
        } catch (error) {
          console.error("Error fetching live chat messages:", error);
        }
      }

      function addCheckboxToMessages() {
        const messages = document.querySelectorAll(".chat-message");

        messages.forEach((message) => {
          const messageId = message.getAttribute("data-message-id");
          const uniqueId = `checkbox-${messageId}`;

          if (!message.querySelector(".message-checkbox")) {
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = uniqueId;
            checkbox.className = "message-checkbox";
            checkbox.addEventListener("change", (e) =>
              handleCheckboxChange(checkbox)
            );

            const container = document.createElement("div");
            container.className = "message-container";
            container.appendChild(checkbox);

            const messageContent = document.createElement("div");
            messageContent.className = "message-text";
            messageContent.innerHTML = message.innerHTML;

            container.appendChild(messageContent);
            message.innerHTML = "";
            message.appendChild(container);

            const savedState = localStorage.getItem(uniqueId);
            if (savedState !== null) {
              checkbox.checked = savedState === "true";
              applyStylesOnLoad(checkbox, message);
            }
          }

          if (isSpecialMessage(message)) {
            styleSpecialMessage(message);
          }
        });
      }

      // Function to add the "Uncheck All" button functionality
      document
        .getElementById("uncheck-all-button")
        .addEventListener("click", () => {
          document.querySelectorAll(".message-checkbox").forEach((checkbox) => {
            checkbox.checked = false;
            const message = checkbox.closest(".chat-message");
            applyLineThrough(message, false);
          });
          saveCheckboxState();
        });

      // Function to apply styles on page load based on saved state
      function applyStylesOnLoad(checkbox, message) {
        if (!checkbox || !message) return;

        const textDecoration = checkbox.checked ? "line-through" : "none";
        styleMessage(message, textDecoration);
      }

      // Function to check if a message is a special type (like Super Chat, Member Message)
      function isSpecialMessage(message) {
        return message.matches(
          "yt-live-chat-paid-message-renderer, yt-live-chat-member-message-renderer"
        );
      }

      // Function to style a message based on textDecoration (line-through or none)
      function styleMessage(message, textDecoration) {
        if (!message) return;

        message.style.textDecoration = textDecoration;
        message.style.color = textDecoration === "line-through" ? "gray" : "";
        message.style.opacity = textDecoration === "line-through" ? "0.7" : "";
        message.style.textDecorationThickness = "2px";

        const userName = message.querySelector("#author-name");
        if (userName) {
          userName.style.textDecoration = textDecoration;
          userName.style.color =
            textDecoration === "line-through" ? "gray" : "";
          userName.style.textDecorationThickness = "2px";
        }

        const images = message.querySelectorAll("img");
        images.forEach((img) => {
          const imgParent = img.parentElement;

          if (textDecoration === "line-through") {
            if (!imgParent.querySelector(".line-through-overlay")) {
              const line = document.createElement("div");
              line.className = "line-through-overlay";
              imgParent.appendChild(line);
              line.style.display = "block";
            }
          } else {
            const line = imgParent.querySelector(".line-through-overlay");
            if (line) {
              line.remove();
            }
          }
        });
      }

      // Function to style special messages like Super Chat and Member Messages
      function styleSpecialMessage(message) {
        if (!message || isPinnedMessage(message)) return;

        message.style.border = "2px solid gold";
        message.style.padding = "5px";
        message.style.borderRadius = "8px";
        message.style.backgroundColor = "rgba(255, 215, 0, 0.2)";

        const username = message.querySelector("#author-name");
        if (username) {
          username.style.fontWeight = "bold";
          username.style.color = "orange";
        }

        // Placeholder for special image
        const moneyImg = document.createElement("img");
        moneyImg.src = "your-money-image-url-here"; // Replace with actual image path
        moneyImg.style.height = "20px";
        moneyImg.style.width = "20px";
        moneyImg.style.marginRight = "5px";
        message.querySelector(".message-text").insertBefore(moneyImg, username);
      }

      // Function to check if the message is a pinned message
      function isPinnedMessage(message) {
        return message.querySelector(".pinned-message") !== null;
      }

      // Handle checkbox change event
      function handleCheckboxChange(checkbox) {
        const message = checkbox.closest(".chat-message");
        const checked = checkbox.checked;
        applyStylesOnLoad(checkbox, message);

        if (checked) {
          const allMessages = Array.from(
            document.querySelectorAll(".chat-message")
          );
          const index = allMessages.indexOf(message);
          for (let i = 0; i <= index; i++) {
            applyLineThrough(allMessages[i], true);
          }
        } else {
          applyLineThrough(message, false);
          const allMessages = Array.from(
            document.querySelectorAll(".chat-message")
          );
          const index = allMessages.indexOf(message);
          for (let i = index + 1; i < allMessages.length; i++) {
            applyLineThrough(allMessages[i], false);
          }
        }
        saveCheckboxState();
      }

      // Apply line-through style to messages
      function applyLineThrough(message, apply) {
        const textDecoration = apply ? "line-through" : "none";
        styleMessage(message, textDecoration);

        // Synchronize checkbox state with message state
        const checkbox = message.querySelector(".message-checkbox");
        if (checkbox) {
          checkbox.checked = apply;
        }
      }

      // Save checkbox states to localStorage
      function saveCheckboxState() {
        document.querySelectorAll(".message-checkbox").forEach((checkbox) => {
          const messageId = checkbox
            .closest(".chat-message")
            .getAttribute("data-message-id");
          localStorage.setItem(`checkbox-${messageId}`, checkbox.checked);
        });
      }

      // Display chat messages
      function displayChatMessages(messages) {
        const chatMessagesContainer = document.getElementById("chatMessages");
        chatMessagesContainer.innerHTML = "";

        messages.forEach((message) => {
          const messageElement = document.createElement("div");
          messageElement.className = "chat-message mt-3";
          messageElement.setAttribute("data-message-id", message.id); // Set a unique ID for each message
          messageElement.innerHTML = `
            <div class="message-container">
                <img src="${message.authorDetails.profileImageUrl}" class="ms-3 profile-img">
              <div class="me-3">${message.snippet.displayMessage}</div>
              <div class="message-text">${message.snippet.displayMessage}</div>
            </div>
          `;

          chatMessagesContainer.appendChild(messageElement);
        });

        addCheckboxToMessages();
      }

      // Fetch and display chat messages when the button is clicked
      document
        .getElementById("fetchChat")
        .addEventListener("click", async () => {
          const channelName = document.getElementById("channelName").value;
          if (channelName) {
            const channelId = await getChannelId(channelName);
            if (channelId) {
              const videoId = await getLatestLiveVideoId(channelId);
              if (videoId) {
                const liveChatId = await getActiveLiveChatId(videoId);
                if (liveChatId) {
                  fetchLiveChatMessages(liveChatId);
                }
              }
            }
          }
        });
    </script>
  </body>
</html>
